<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –∏–≥—Ä—ã</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { margin:0; height:100%; }
  #map { width:100%; height:100%; background:#000; }
  .popup-buttons { display:flex; flex-direction:column; gap:4px; margin-top:5px; }
  button { cursor:pointer; border:none; padding:4px 8px; border-radius:4px; background-color:#eee; }
  button:hover { background-color:#ccc; }
  a { color:#0077cc; text-decoration:none; }
  a:hover { text-decoration:underline; }

  #controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: rgba(255,255,255,0.9);
    padding: 8px;
    border-radius: 6px;
    font-family: sans-serif;
  }
  #categoryFilter { margin-left: 5px; }

  .add-form {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .add-form input, .add-form select {
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #aaa;
  }
  .add-form button {
    background: #0078ff;
    color: white;
    border: none;
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
  }
  .add-form button:hover { background: #005fcc; }
</style>
</head>
<body>

<div id="controls">
  <label for="categoryFilter">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
  <select id="categoryFilter">
    <option value="all">–í—Å–µ</option>
    <option value="–î–∞–Ω–∂–∏">–î–∞–Ω–∂–∏</option>
    <option value="–ü–æ—Ä—Ç–∞–ª—ã">–ü–æ—Ä—Ç–∞–ª—ã</option>
    <option value="–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)">–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)</option>
    <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
    <option value="–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã">–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "morrowind-map-1b449.firebaseapp.com",
  databaseURL: "https://morrowind-map-1b449-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId: "morrowind-map-1b449",
  storageBucket: "morrowind-map-1b449.appspot.com",
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const img = new Image();
img.src = 'map.png';
img.onload = function() {
  const imageWidth = img.width;
  const imageHeight = img.height;

  const map = L.map('map', { crs:L.CRS.Simple, minZoom:-1, maxZoom:3 });
  const bounds = [[0,0],[imageHeight,imageWidth]];
  window.imageLayer = L.imageOverlay('map.png', bounds).addTo(map);
  map.fitBounds(bounds);

  let markers = [];

  function createPopupContent(marker) {
    const div = document.createElement('div');
    div.innerHTML = `<strong>${marker.options.text}</strong><br><em>${marker.options.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</em>`;
    if(marker.options.url){
      const link = document.createElement('a');
      link.href = marker.options.url;
      link.target='_blank';
      link.textContent='–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É üîó';
      link.style.display='block';
      link.style.marginTop='5px';
      div.appendChild(link);
    }

    const buttons = document.createElement('div');
    buttons.className = 'popup-buttons';

    const editBtn = document.createElement('button');
    editBtn.textContent = '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å';
    editBtn.onclick = () => {
      const form = document.createElement('div');
      form.className = 'add-form';
      form.innerHTML = `
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
        <input type="text" id="editName" value="${marker.options.text}"/>
        <label>–°—Å—ã–ª–∫–∞:</label>
        <input type="text" id="editUrl" value="${marker.options.url||''}"/>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select id="editCategory">
          <option value="–î–∞–Ω–∂–∏">–î–∞–Ω–∂–∏</option>
          <option value="–ü–æ—Ä—Ç–∞–ª—ã">–ü–æ—Ä—Ç–∞–ª—ã</option>
          <option value="–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)">–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)</option>
          <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
          <option value="–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã">–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</option>
        </select>
        <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      `;
      form.querySelector('#editCategory').value = marker.options.category || '–î—Ä—É–≥–æ–µ';

      const popup = L.popup().setLatLng(marker.getLatLng()).setContent(form).openOn(map);

      form.querySelector('#saveBtn').addEventListener('click', ()=>{
        const newText = form.querySelector('#editName').value.trim();
        const newUrl = form.querySelector('#editUrl').value.trim();
        const newCategory = form.querySelector('#editCategory').value;

        if(!newText) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');

        marker.options.text = newText;
        marker.options.url = newUrl;
        marker.options.category = newCategory;
        marker.setPopupContent(createPopupContent(marker));

        db.ref('points').orderByChild('lat').equalTo(marker.getLatLng().lat).once('value', snap=>{
          snap.forEach(child=>{
            if(child.val().lng===marker.getLatLng().lng){
              child.ref.update({text:newText,url:newUrl,category:newCategory});
            }
          });
        });
        map.closePopup();
      });
    };

    const delBtn = document.createElement('button');
    delBtn.textContent = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
    delBtn.onclick = () => {
      map.removeLayer(marker);
      markers = markers.filter(m => m !== marker);
      db.ref('points').orderByChild('lat').equalTo(marker.getLatLng().lat).once('value', snap=>{
        snap.forEach(child=>{
          if(child.val().lng===marker.getLatLng().lng) child.ref.remove();
        });
      });
    };

    buttons.appendChild(editBtn);
    buttons.appendChild(delBtn);
    div.appendChild(buttons);
    return div;
  }

  function addMarker(lat,lng,text,url,category,save=true){
    const marker = L.marker([lat,lng], {text,url,category}).addTo(map);
    marker.bindPopup(createPopupContent(marker));
    markers.push(marker);
    if(save){
      const newPoint = db.ref('points').push();
      newPoint.set({lat,lng,text,url,category});
    }
  }

  // === –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ===
  const categoryFilter = document.getElementById('categoryFilter');
  categoryFilter.addEventListener('change', () => {
    const selected = categoryFilter.value;
    markers.forEach(marker => {
      if (selected === 'all' || marker.options.category === selected) {
        marker.addTo(map);
      } else {
        map.removeLayer(marker);
      }
    });
  });

  // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Üí —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
  map.on('click', e=>{
    const form = document.createElement('div');
    form.className='add-form';
    form.innerHTML=`
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label><input type="text" id="nameInput"/>
      <label>–°—Å—ã–ª–∫–∞:</label><input type="text" id="urlInput"/>
      <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
      <select id="categoryInput">
        <option value="–î–∞–Ω–∂–∏">–î–∞–Ω–∂–∏</option>
        <option value="–ü–æ—Ä—Ç–∞–ª—ã">–ü–æ—Ä—Ç–∞–ª—ã</option>
        <option value="–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)">–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)</option>
        <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
        <option value="–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã">–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</option>
      </select>
      <button id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
    `;
    const popup = L.popup().setLatLng(e.latlng).setContent(form).openOn(map);

    form.querySelector('#addBtn').addEventListener('click', ()=>{
      const name = form.querySelector('#nameInput').value.trim();
      if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');
      const url = form.querySelector('#urlInput').value.trim();
      const category = form.querySelector('#categoryInput').value;
      addMarker(e.latlng.lat,e.latlng.lng,name,url,category,true);
      map.closePopup();
    });
  });

  // === Firebase —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ===
  db.ref('points').on('child_added', snapshot=>{
    const p = snapshot.val();
    addMarker(p.lat,p.lng,p.text,p.url,p.category,false);
  });
  db.ref('points').on('child_changed', snapshot=>{
    const p = snapshot.val();
    const m = markers.find(m => m.getLatLng().lat===p.lat && m.getLatLng().lng===p.lng);
    if(m){ 
      m.options.text = p.text; 
      m.options.url = p.url; 
      m.options.category = p.category;
      m.setPopupContent(createPopupContent(m)); 
    }
  });
  db.ref('points').on('child_removed', snapshot=>{
    const p = snapshot.val();
    const m = markers.find(m => m.getLatLng().lat===p.lat && m.getLatLng().lng===p.lng);
    if(m){ map.removeLayer(m); markers=markers.filter(x=>x!==m); }
  });
};
</script>
</body>
</html>
