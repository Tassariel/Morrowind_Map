<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –∏–≥—Ä—ã</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { margin:0; height:100%; }
  #map { width:100%; height:100%; background:#000; }
  .popup-buttons { display:flex; flex-direction:column; gap:4px; margin-top:5px; }
  button { cursor:pointer; border:none; padding:4px 8px; border-radius:4px; background-color:#eee; }
  button:hover { background-color:#ccc; }
  a { color:#0077cc; text-decoration:none; }
  a:hover { text-decoration:underline; }
</style>
</head>
<body>
<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "morrowind-map-1b449.firebaseapp.com",
    databaseURL: "https://morrowind-map-1b449-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "morrowind-map-1b449",
    storageBucket: "morrowind-map-1b449.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ===== –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ =====
  const img = new Image();
  img.src = 'map.png';
  img.onload = function() {
    const imageWidth = img.width;
    const imageHeight = img.height;

    // ===== –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É =====
    const map = L.map('map', { crs:L.CRS.Simple, minZoom:-1, maxZoom:3 });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è bounds —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –ø–æ–¥ –æ–∫–Ω–æ
    function resizeMap() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      const ratio = imageWidth / imageHeight;
      let displayWidth, displayHeight;

      if (w / h > ratio) {
        // –æ–∫–Ω–æ —à–∏—Ä–µ ‚Üí –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ –≤—ã—Å–æ—Ç–µ
        displayHeight = imageHeight;
        displayWidth = imageHeight * ratio;
      } else {
        // –æ–∫–Ω–æ –≤—ã—à–µ ‚Üí –ø–æ–¥–≥–æ–Ω—è–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ
        displayWidth = imageWidth;
        displayHeight = imageWidth / ratio;
      }

      const bounds = [[0,0],[displayHeight,displayWidth]];
      if(window.imageLayer) map.removeLayer(window.imageLayer);
      window.imageLayer = L.imageOverlay('map.png', bounds).addTo(map);
      map.fitBounds(bounds);
    }

    resizeMap();
    window.addEventListener('resize', resizeMap);

    let markers = [];

    function createPopupContent(marker) {
      const div = document.createElement('div');
      div.innerHTML = `<strong>${marker.options.text}</strong>`;
      if(marker.options.url){
        const link=document.createElement('a');
        link.href=marker.options.url;
        link.target='_blank';
        link.textContent='–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É üîó';
        link.style.display='block';
        link.style.marginTop='5px';
        div.appendChild(link);
      }

      const buttons=document.createElement('div');
      buttons.className='popup-buttons';

      const editBtn=document.createElement('button');
      editBtn.textContent='‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å';
      editBtn.onclick=()=>{
        const newText=prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏:', marker.options.text);
        const newUrl=prompt('–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π):', marker.options.url||'');
        if(newText!==null){
          marker.options.text=newText;
          marker.options.url=newUrl;
          marker.setPopupContent(createPopupContent(marker));
          // Firebase update
          db.ref('points').orderByChild('lat').equalTo(marker.getLatLng().lat).once('value', snap=>{
            snap.forEach(child=>{
              if(child.val().lng===marker.getLatLng().lng) child.ref.update({text:newText,url:newUrl});
            });
          });
        }
      };

      const delBtn=document.createElement('button');
      delBtn.textContent='üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
      delBtn.onclick=()=>{
        map.removeLayer(marker);
        markers=markers.filter(m=>m!==marker);
        db.ref('points').orderByChild('lat').equalTo(marker.getLatLng().lat).once('value', snap=>{
          snap.forEach(child=>{
            if(child.val().lng===marker.getLatLng().lng) child.ref.remove();
          });
        });
      };

      buttons.appendChild(editBtn);
      buttons.appendChild(delBtn);
      div.appendChild(buttons);
      return div;
    }

    function addMarker(lat,lng,text,url,save=true){
      const marker=L.marker([lat,lng],{text,url}).addTo(map);
      marker.bindPopup(createPopupContent(marker));
      markers.push(marker);
      if(save){
        const newPoint=db.ref('points').push();
        newPoint.set({lat,lng,text,url});
      }
    }

    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ‚Üí –Ω–æ–≤–∞—è –º–µ—Ç–∫–∞
    map.on('click', e=>{
      const name=prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏:');
      if(!name) return;
      const url=prompt('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):');
      addMarker(e.latlng.lat,e.latlng.lng,name,url||'',true);
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–æ–∫ –∏–∑ Firebase
    db.ref('points').on('child_added', snapshot=>{
      const p=snapshot.val();
      addMarker(p.lat,p.lng,p.text,p.url,false);
    });

    db.ref('points').on('child_changed', snapshot=>{
      const p=snapshot.val();
      const m=markers.find(m=>m.getLatLng().lat===p.lat && m.getLatLng().lng===p.lng);
      if(m){ m.options.text=p.text; m.options.url=p.url; m.setPopupContent(createPopupContent(m)); }
    });

    db.ref('points').on('child_removed', snapshot=>{
      const p=snapshot.val();
      const m=markers.find(m=>m.getLatLng().lat===p.lat && m.getLatLng().lng===p.lng);
      if(m){ map.removeLayer(m); markers=markers.filter(x=>x!==m); }
    });
  };
</script>
</body>
</html>
