<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –∏–≥—Ä—ã</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { margin:0; height:100%; }
  #map { width:100%; height:100%; background:#000; }
  .popup-buttons { display:flex; flex-direction:column; gap:4px; margin-top:5px; }
  button { cursor:pointer; border:none; padding:4px 8px; border-radius:4px; background-color:#eee; }
  button:hover { background-color:#ccc; }
  a { color:#0077cc; text-decoration:none; }
  a:hover { text-decoration:underline; }

  /* === –§–ò–õ–¨–¢–† === */
  #controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
    background: rgba(255,255,255,0.9);
    padding: 8px;
    border-radius: 6px;
    font-family: sans-serif;
  }
  #categoryFilter {
    margin-left: 5px;
  }

  /* === –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø === */
  .add-form {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .add-form input, .add-form select {
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #aaa;
  }
  .add-form button {
    background: #0078ff;
    color: white;
    border: none;
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
  }
  .add-form button:hover {
    background: #005fcc;
  }
</style>
</head>
<body>

<!-- === –§–ò–õ–¨–¢–† === -->
<div id="controls">
  <label for="categoryFilter">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
  <select id="categoryFilter">
    <option value="all">–í—Å–µ</option>
    <option value="–î–∞–Ω–∂–∏">–î–∞–Ω–∂–∏</option>
    <option value="–ü–æ—Ä—Ç–∞–ª—ã">–ü–æ—Ä—Ç–∞–ª—ã</option>
    <option value="–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)">–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)</option>
    <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
  </select>
</div>

<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "morrowind-map-1b449.firebaseapp.com",
    databaseURL: "https://morrowind-map-1b449-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "morrowind-map-1b449",
    storageBucket: "morrowind-map-1b449.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ===== –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É =====
  const img = new Image();
  img.src = 'map.png';
  img.onload = function() {
    const imageWidth = img.width;
    const imageHeight = img.height;

    const map = L.map('map', { crs:L.CRS.Simple, minZoom:-1, maxZoom:3 });

    function resizeMap() {
      const bounds = [[0,0],[imageHeight,imageWidth]];
      if(window.imageLayer) map.removeLayer(window.imageLayer);
      window.imageLayer = L.imageOverlay('map.png', bounds).addTo(map);
      map.fitBounds(bounds);
    }

    resizeMap();
    window.addEventListener('resize', resizeMap);

    let markers = [];

    function createPopupContent(marker) {
      const div = document.createElement('div');
      div.innerHTML = `<strong>${marker.options.text}</strong><br><em>${marker.options.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</em>`;
      if(marker.options.url){
        const link=document.createElement('a');
        link.href=marker.options.url;
        link.target='_blank';
        link.textContent='–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É üîó';
        link.style.display='block';
        link.style.marginTop='5px';
        div.appendChild(link);
      }

      const buttons=document.createElement('div');
      buttons.className='popup-buttons';

      const editBtn=document.createElement('button');
      editBtn.textContent='‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å';
      editBtn.onclick=()=>{
        const newText=prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏:', marker.options.text);
        const newUrl=prompt('–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π):', marker.options.url||'');
        const newCategory=prompt('–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–î–∞–Ω–∂–∏, –ü–æ—Ä—Ç–∞–ª—ã, –¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç), –î—Ä—É–≥–æ–µ):', marker.options.category||'');
        if(newText!==null){
          marker.options.text=newText;
          marker.options.url=newUrl;
          marker.options.category=newCategory;
          marker.setPopupContent(createPopupContent(marker));
          db.ref('points').orderByChild('lat').equalTo(marker.getLatLng().lat).once('value', snap=>{
            snap.forEach(child=>{
              if(child.val().lng===marker.getLatLng().lng) child.ref.update({text:newText,url:newUrl,category:newCategory});
            });
          });
        }
      };

      const delBtn=document.createElement('button');
      delBtn.textContent='üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
      delBtn.onclick=()=>{
        map.removeLayer(marker);
        markers=markers.filter(m=>m!==marker);
        db.ref('points').orderByChild('lat').equalTo(marker.getLatLng().lat).once('value', snap=>{
          snap.forEach(child=>{
            if(child.val().lng===marker.getLatLng().lng) child.ref.remove();
          });
        });
      };

      buttons.appendChild(editBtn);
      buttons.appendChild(delBtn);
      div.appendChild(buttons);
      return div;
    }

    function addMarker(lat,lng,text,url,category,save=true){
      const marker=L.marker([lat,lng],{text,url,category}).addTo(map);
      marker.bindPopup(createPopupContent(marker));
      markers.push(marker);
      if(save){
        const newPoint=db.ref('points').push();
        newPoint.set({lat,lng,text,url,category});
      }
    }

    // === –§–ò–õ–¨–¢–† ===
    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter.addEventListener('change', () => {
      const selected = categoryFilter.value;
      markers.forEach(marker => {
        if (selected === 'all' || marker.options.category === selected) {
          marker.addTo(map);
        } else {
          map.removeLayer(marker);
        }
      });
    });

    // === –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É ===
    map.on('click', e=>{
      const form = document.createElement('div');
      form.className = 'add-form';
      form.innerHTML = `
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
        <input id="nameInput" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏"/>
        <label>–°—Å—ã–ª–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
        <input id="urlInput" type="text" placeholder="https://..."/>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select id="categoryInput">
          <option value="–î–∞–Ω–∂–∏">–î–∞–Ω–∂–∏</option>
          <option value="–ü–æ—Ä—Ç–∞–ª—ã">–ü–æ—Ä—Ç–∞–ª—ã</option>
          <option value="–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)">–¢—ã–∫–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è (–∏–≤–µ–Ω—Ç)</option>
          <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
        </select>
        <button id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      `;

      const popup = L.popup()
        .setLatLng(e.latlng)
        .setContent(form)
        .openOn(map);

      form.querySelector('#addBtn').addEventListener('click', () => {
        const name = form.querySelector('#nameInput').value.trim();
        if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');
        const url = form.querySelector('#urlInput').value.trim();
        const category = form.querySelector('#categoryInput').value;
        addMarker(e.latlng.lat, e.latlng.lng, name, url, category, true);
        map.closePopup();
      });
    });

    // === Firebase sync ===
    db.ref('points').on('child_added', snapshot=>{
      const p=snapshot.val();
      addMarker(p.lat,p.lng,p.text,p.url,p.category,false);
    });

    db.ref('points').on('child_changed', snapshot=>{
      const p=snapshot.val();
      const m=markers.find(m=>m.getLatLng().lat===p.lat && m.getLatLng().lng===p.lng);
      if(m){ 
        m.options.text=p.text; 
        m.options.url=p.url; 
        m.options.category=p.category;
        m.setPopupContent(createPopupContent(m)); 
      }
    });

    db.ref('points').on('child_removed', snapshot=>{
      const p=snapshot.val();
      const m=markers.find(m=>m.getLatLng().lat===p.lat && m.getLatLng().lng===p.lng);
      if(m){ map.removeLayer(m); markers=markers.filter(x=>x!==m); }
    });
  };
</script>
</body>
</html>
